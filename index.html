<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
          "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <title>Tom Goodman</title>
    <meta name="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="jquery.console.js"></script>
    <script type="text/javascript">
      $(document).ready(function(){
         // Prototype to handle items in the 'filesystem'
         function Item(name, dir_b = false, owner = "tomg.io", group = "user", owner_a = "7", group_a = "4", other_a = "4", items = []) {
             this.name = name; // The identifier of the item
             this.dir_b = dir_b; // Is this item a directory? (Defaults to false)
             this.owner = owner; // Who owns this item? (Defaults to tomg.io)
             this.group = group; // What group does this item belong to? (Defaults to user) 
             // Access perms... 
             this.owner_a = owner_a; // Owner - defaults to 7 
             this.group_a = group_a; // Group - defaults to 4
             this.other_a = other_a; // Other - defaults to 4

             this.items = items; // If this is a directory, it might contain other items...
         }

         // Mapping from users to an array of their groups
         var users_groups = {
             "visitor" : ["visitor", "user"],
             "tomg.io" : ["owner", "user"]
         }

         // Mapping from access number to rwx combination
         var access_map = {
             "0" : "---",
             "1" : "--x",
             "2" : "-w-", 
             "3" : "-wx", 
             "4" : "r--", 
             "5" : "r-x", 
             "6" : "rw-", 
             "7" : "rwx"
         }

         var CV = new Item("CV.pdf");
 
         // CONSTRUCT THE FILESYSTEM
         var home = new Item("~", true);
         home.items.push(CV); // Put our CV in the home directory.
  
         // Keep track of which directory we're at! 
         var currentdir = home;      
         // Keep track of the current user.   
         var currentuser = "visitor";
        
         // TODO keep a nice array of cmd objects instead! 
         var cmds = ["ls", "evince", "exit"]  
         var cmds_desc = ["list all files in the current directory", "open a pdf file in a new tab", "close the tab"];  
     
         // Regex to split input into command, flags and args
         var split_re = /\s*(\S+)\s?((-{1,2}\S*\s?)*)*\s?("?.*"?\s?)*/
        
         // Regex to split args 
         var args_split_re = /(".*"|\S*)*/;
 
         var console1 = $('<div class="console1">');
         $('body').append(console1);
         var controller1 = console1.console({
           promptLabel: 'visitor@tomg.io:~$ ',
           commandValidate:function(line){
             return true;
           },
           commandHandle:function(line){
           // split the input into command, flags and args
           var split_line = line.split(split_re);           
           if(split_line == [""]) return [{msg:"tomsh: command not found",className:"jquery-console-message-value"}];
 
           // grab the command
           var command_b = false;
           var command;
           if(split_line.length >= 1) {
               command = split_line[1];
               command_b = true;
           }
 
           // Now grab the flags
           var flags_b = false;
           var flags;
           if(split_line[2] != undefined) {
               flags = split_line[2]; //TODO: Make this less naive
               flags_b = true;
	   }
    
           // Now grab the args
           var args_b = false;
           var args;
           if(split_line[4] != undefined) {
               args = split_line[4].split(args_split_re);
               // Splice "" and " " from the array
               var index = args.indexOf("");
               while(index > -1) {
                   args.splice(index, 1);
                   index = args.indexOf("");
               }
               index = args.indexOf(" ");
               while(index > -1) {
                   args.splice(index, 1);
                   index = args.indexOf(" ");
               }
               args_b = true;
           }

           // Common error messages 
           var invalid_flags = function(command, flags) {
               return [{msg:command + ": invalid option: " + flags,className:"jquery-console-message-value"}];
           }
           var return_message = function(msg) {
               return [{msg:msg,className:"jquery-console-message-value"}];
           }
           
           // exit
           if(command == "help") {
               var message = "";
               for(var i = 0; i < cmds.length; i++) { 
                   message += cmds[i] + " - " + cmds_desc[i] + "\n";
               }
               return return_message(message);
           }
           if(command == "exit") close(); 
           if(command == "exit") return [{msg:"The exit command does not work with your browser.",className:"jquery-console-message-value"}];
           if(command == "groups") {
               if(flags_b) {
                   return invalid_flags(command, flags);
               }
               
           }
           // ls
           if(command == "ls") {
               // Check the flags and do what they want
               if(flags_b) {
                   // -l flag : List access rights
                   if(flags == "-l") { 
                       for(var i = 0; i < currentdir.items.length; i++) {
                            var item = currentdir.items[i];
                            var message = "";
                            // Is it a directory?
                            if(item.dir_b) message += "d";
                            else message += "-";
                            // Add on the 3 access perms
                            message += access_map[item.owner_a];
                            message += access_map[item.group_a];
                            message += access_map[item.other_a];
                            message += ". 1 "; // For now, it has 1 link as we don't have symbolic links.
                            message += item.owner + " ";
                            message += item.group + " ";
                            // TODO: Implement filesize and show it here
                            // TODO: Implement timestamp and show it here
                            message += item.name;
                            message += "\n";
                       }
                       return return_message(message);
                   }
                   // For now, just say unrecognised option(s) + flag(s).
                   return invalid_flags(command, flags)
               }
               var message = "";
               console.log(currentdir);
               // For each item in the current directory...
               for(var i = 0; i < currentdir.items.length; i++) {
                   // Concatenate it's name, followed by a space
                   message += currentdir.items[i].name + " ";
               }
               return return_message(message);
           }
           // evince 
           if(command == "evince") {

               // Check the flags and do what they want
               if(flags_b) {
                   // There are no flags for "evince"...
                   return invalid_flags(command, flags);
               }
               var length = 0;
               if(args_b) length = args.length;
               if(length != 1) {
                   return [{msg: command + ": invalid number of arguments, "+ length + ", expected 1", className:"jquery-console-message-value"}]; 
               }
               // TODO: Should probably check if what we're opening is a pdf...
               for(var i = 0; i < currentdir.items.length; i++) {
                   var name = currentdir.items[0].name;
                   if(args[0] == name) {
                       window.open(name);
                       return [{msg: command + ": opening file, "+args[0], className:"jquery-console-message-value"}];
                   }
               }
               return [{msg: command + ": invalid filepath, "+args[0], className:"jquery-console-message-value"}];
           } 
           // error
           return [{msg:"tomsh: " + command + ": command not found",className:"jquery-console-message-value"}];

           },
           autofocus:true,
           animateScroll:true,
           promptHistory:true,
           });
        });
    </script>
    
    <style>
      console1 {
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
      }
    </style>
    <style type="text/css" media="screen">
      body {
          top: 0;
          left: 0;
          margin: 0;
          padding: 0;
          overflow-x: hidden;
          overflow-y: hidden;
      }
      div.console1 { word-wrap: break-word; }
      div.console1 { font-size: 14px }
      div.console1 div.jquery-console-inner
       { width:100vw; height:100vh; background:#333; padding:0.5em;
         overflow:auto }
      div.console1 div.jquery-console-prompt-box
       { color:#fff; font-family:monospace; }
      div.console1 div.jquery-console-focus span.jquery-console-cursor
       { background:#fefefe; color:#333; font-weight:bold }
      div.console1 div.jquery-console-message-error
       { color:#ef0505; font-family:sans-serif; font-weight:bold;
         padding:0.1em; }
      div.console1 div.jquery-console-message-value
       { color:#1ad027; font-family:monospace;
         padding:0.1em; }
      div.console1 div.jquery-console-message-type
       { color:#52666f; font-family:monospace;
         padding:0.1em; }
      div.console1 span.jquery-console-prompt-label { font-weight:bold }
    </style>
  </head>
  <body>
  </body>
</html>
