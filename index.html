<!doctype html>
<html>
  <head>
    <title>Tom Goodman</title>
    <meta name="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="jquery.console.js"></script>
    <script type="text/javascript">
      $(document).ready(function(){
           const MAX_FILESIZE_LENGTH = 6;

           // Return the current user
           function curuser() { return currentuser; }

           // Return whether or not a file is empty
           function isEmpty(filename) {
               for(var i = 0; i < currentdir.items.length; i++) {
                   var item = currentdir.items[i];
                   if(item.name == filename) {
                       return item.empty;
                   }
               }
               return true; // I guess?
           }

           // Get current timestamp in correct format
           function timestamp() {
               var c_ts = (new Date(Date.now())).toString();
               var c_ts_split = c_ts.split(" ");
               return c_ts_split[1] + " " + c_ts_split[2] + " " + c_ts_split[4];    
           }

           function sizepad(s) {
               var pad_n = MAX_FILESIZE_LENGTH - s.length;
               var padding = "";
               if(pad_n == 0) return s;
               for(var i = 0; i < pad_n; i++) {
                   padding += " ";
               }
               return padding + s;
           }
        
           function contains(a, obj) {
               for (var i = 0; i < a.length; i++) {
                   if (a[i] === obj) {
                       return true;
                   }
               }
               return false;
           }

           // Aux function used in commands such as ls
           function get_filenames() {
               names = [];
               for(var j = 0; j < currentdir.items.length; j++) {
                   names.push(currentdir.items[j].name);
               }
               return names;
           }

 
           // Prototype to handle items in the 'filesystem'
           function Item(name, size=sizepad(0), empty=false, data="", dir_b = false, owner = curuser(), group = "user", owner_a = "6", group_a = "4", other_a = "4", items = [],  ts=timestamp()) {
               this.name = name; // The identifier of the item
               this.empty = empty; 
               this.size = sizepad(size); // The size, in bytes, of the item
               this.dir_b = dir_b; // Is this item a directory? (Defaults to false)
               this.owner = owner; // Who owns this item? (Defaults to tomg.io)
               this.group = group; // What group does this item belong to? (Defaults to user) 
               // Access perms... 
               this.owner_a = owner_a; // Owner - defaults to 7 
               this.group_a = group_a; // Group - defaults to 4
               this.other_a = other_a; // Other - defaults to 4
 
               this.items = items; // If this is a directory, it might contain other items...
               this.ts = ts;

               this.data = data;
           }
           // Prototype to handle tomsh cmds
           function Cmd(name, help="there is no help text for this command" , man="there is no manual for this command") {
               this.name = name; // Identifier of the cmd
               this.help = help; // Short help text for the cmd
               this.man = man; // Full manual text for the cmd
           }

           // Mapping from users to an array of their groups
           var users_groups = {
               "visitor" : ["visitor", "user"],
               "tomg.io" : ["owner", "user"]
           }

           // Mapping from access number to rwx combination
           var access_map = {
               "0" : "---",
               "1" : "--x",
               "2" : "-w-", 
               "3" : "-wx", 
               "4" : "r--", 
               "5" : "r-x", 
               "6" : "rw-", 
               "7" : "rwx"
           }
 
           // Set these perms for original filesystem
           var currentuser = "tomg.io";

           // CONSTRUCT THE FILESYSTEM
           var CV = new Item("CV.pdf", "149051");
           var Contact = new Item("contact.txt", "370");
           var Edu = new Item("education.txt", "1337");
           var Hey = new Item("hey.txt", "775");
           var home = new Item("~", true);

           home.items.push(Contact); // Put Contact.txt in the home directory.
           home.items.push(CV); // Put our CV in the home directory.
           home.items.push(Edu); 
           home.items.push(Hey); 

           // Keep track of which directory we're at! 
           var currentdir = home;      
           // Keep track of the filepath too
           var filepath = ["~"];
           // Keep track of the current user.   
           currentuser = "visitor";

    
           // DEFINE ALL OF THE AVAILABLE COMMANDS
           const CMDS  = []     
  
           const cat = new Cmd("cat", "concatenate files and print them to standard output\nusage: cat <file 1> <file 2>...");
           const evince = new Cmd("evince", "open a pdf file in a new tab\n usage: evince <filepath>");
           const exit   = new Cmd("exit", "close the tab\n usage: exit");
           const groups = new Cmd("groups", "list the groups that you belong to\nusage: groups");
           const help   = new Cmd("help", "list all available commands, or provide a description of a given command\n usage: help <command>");
           const ls     = new Cmd("ls", "list all items in the current directory\nusage: ls <flags>\n type 'man ls' for more details");
           const man    = new Cmd("man", "shows the manual for a given command\n usage: man <command>");
           const mkdir  = new Cmd("mkdir", "creates a directory with the given name in the current directory.\nusage: mkdir <name>\n STILL IN DEVELOPMENT - WILL NOT WORK!");
           const touch  = new Cmd("touch", "change file timestamps\n usage: touch <file>");     
 
           CMDS.push(cat);
           CMDS.push(evince);
           CMDS.push(exit);
           CMDS.push(groups);
           CMDS.push(help); 
           CMDS.push(ls);
           CMDS.push(man);
           CMDS.push(touch);
           CMDS.push(mkdir);

           // Regex to split input into command, flags and args
           var split_re = /\s*(\S+)\s?((-{1,2}\S*\s?)*)*\s?("?.*"?\s?)*/
        
           // Regex to split args 
           var args_split_re = /(".*"|\S*)*/;
 
           var console1 = $('<div class="console1">');
           $('body').append(console1);
           var controller1 = console1.console({
           promptLabel: 'visitor@tomg.io:~$ ',
           commandValidate:function(line){
                return true;
           },
           commandHandle:function(line){
           // split the input into command, flags and args
           var split_line = line.split(split_re);      
           if(split_line.length <= 1) return [{msg:"",className:"jquery-console-message-value"}];
 
           // grab the command
           var command_b = false;
           var command;
           if(split_line.length >= 1) {
               command = split_line[1];
               command_b = true;
           }
 
           // Now grab the flags
           var flags_b = false;
           var flags;
           if(split_line[2] != undefined) {
               flags = split_line[2]; //TODO: Make this less naive
               flags_b = true;
	   }
    
           // Now grab the args
           var args_b = false;
           var args;
           if(split_line[4] != undefined) {
               args = split_line[4].split(args_split_re);
               // Splice "" and " " from the array
               var index = args.indexOf("");
               while(index > -1) {
                   args.splice(index, 1);
                   index = args.indexOf("");
               }
               index = args.indexOf(" ");
               while(index > -1) {
                   args.splice(index, 1);
                   index = args.indexOf(" ");
               }
               args_b = true;
           }
 
           if(args) {
               // remove surrounding quotes
               for(var i = 0; i < args.length; i++) {
                   var arg = args[i];
                   if(arg != undefined) {
                       if(arg.slice(0,1) == '"' && arg.slice(args.length-1,args.length) == '"') args[i] = arg.slice(1,arg.length -1);
                   }
               }
           }

           // Common error messages 
           var invalid_flags = function(command, flags) {
               return [{msg:command + ": invalid option: " + flags,className:"jquery-console-message-value"}];
           }
           var invalid_args = function(command, args) {
               return [{msg: command + ": invalid args: " + args,className:"jquery-console-message-value"}];
           } 
           var invalid_args_num = function(command, args_num, args_num_e) {
               return [{msg: command + ": invalid number of arguments, "+ args_num + ", expected " + args_num_e, className:"jquery-console-message-value"}]; 
           }
           var invalid_filepath = function(command, filepath) {
               return [{msg: command + ": invalid filepath, "+ filepath, className:"jquery-console-message-value"}];
           }
           var return_message = function(msg) {
               return [{msg:msg,className:"jquery-console-message-value"}];
           }

           
           // DEFINE BEHAVIOUR OF EACH AVAILABLE COMMAND

           // cat
           function cat_c() { 
               // Check for no flags
               if(flags_b) return invalid_flags(command, flags);
               // Check # args - (must be > 0)
               if(!args_b) return invalid_args_num(command, 0, 1);
               // Ensure all files are valid, otherwise error
               var names = get_filenames();
               for(var i = 0; i < args.length; i++) {
                   if(!contains(names ,args[i])) return invalid_filepath(command, args[i]);
               }
               var message = "";
               // Open each file and concatenate them together
               for(var i = 0; i < args.length; i++) {
                   if(isEmpty(args[i])) {
                       message += "";
                   }
                   else {
                       var xhttp = new XMLHttpRequest();
                       xhttp.open("GET", args[i], false);
                       xhttp.onreadystatechange = function () {
                           if(xhttp.readyState == 4) {
                               if(xhttp.status == 200 || xhttp.status == 0) {
                                   message += xhttp.responseText;
                               }
                           }
                       }
                       xhttp.send(null);
                   }
               }
               // Print the resulting string
               return return_message(message);
           }

           // evince 
           function evince_c() {

               // Check the flags and do what they want
               if(flags_b) {
                   // There are no flags for "evince"...
                   return invalid_flags(command, flags);
               }
               var length = 0;
               if(args_b) length = args.length;
               if(length != 1) {
                   return invalid_args_num(command, length, 1);
               }
               // TODO: Should probably check if what we're opening is a pdf...
               for(var i = 0; i < currentdir.items.length; i++) {
                   var name = currentdir.items[i].name;
                   if(args[0] == name) {
                       window.open(name);
                       return [{msg: command + ": opening file, "+args[0], className:"jquery-console-message-value"}];
                   }
               }
               return invalid_filepath(command, args[0]);
           } 

           // exit 
           function exit_c() {
               if(flags_b) return invalid_flags(command, flags);
               if(args_b) return invalid_args_num(command, args.length, 0);
               close();
               return [{msg:"the exit command does not work with your browser",className:"jquery-console-message-value"}];
           }
   
           // groups
           function groups_c() {
               if(flags_b) return invalid_flags(command, flags);
               var message = "";
               var groups = users_groups[currentuser];
               for(var i = 0; i < groups.length; i++) {
                   message += groups[i] + " ";    
               }
               return return_message(message);
           }
           
           // help
           function help_c() {
               // If there are flags, throw the usual error
               if(flags_b) return invalid_flags(command, flags);
               var message = "";
               // If there are no args, return a list of available commands
               if(!args_b) {
                   message += "here is a list of available commands - (use help <command> for details about them):\n";
                   for(var i = 0; i < CMDS.length; i++) {
                       message += CMDS[i].name + "  ";
                   }
                return return_message(message);
               }
               // If there is more or less than one arg, invalid number of args
               var length = 0;
               if(args_b) length = args.length;
               if(length != 1) return invalid_args_num(command, length, 1);
               console.log(CMDS);
               // Otherwise, return the help message about the given command
               for(var i = 0; i < CMDS.length; i++) {
                   var name = CMDS[i].name;
                   if(args[0] == name) return return_message(CMDS[i].help);
               }
               return invalid_args(command, args[0]);
           }
           
           // ls
           function ls_c() {
               // Check the flags and do what they want
               if(flags_b) {
                   // -l flag : List access rights
                   if(flags == "-l") {
                       var message = ""; 
                       for(var i = 0; i < currentdir.items.length; i++) {
                            var item = currentdir.items[i];
                            // Is it a directory?
                            if(item.dir_b) message += "d";
                            else message += "-";
                            // Add on the 3 access perms
                            message += access_map[item.owner_a];
                            message += access_map[item.group_a];
                            message += access_map[item.other_a];
                            message += " 1 "; // For now, it has 1 link as we don't have symbolic links.
                            message += item.owner + " ";
                            message += item.group + " ";
                            message += item.size + " ";
                            message += item.ts + " ";
                            message += item.name;
                            message += "\n";
                       }
                       return return_message(message);
                   }
                   // For now, just say unrecognised option(s) + flag(s).
                   return invalid_flags(command, flags)
               }
               message = "";
               var fns = get_filenames(); 
               for(var i = 0; i < fns.length; i++) {
                   message += fns[i] + "  ";
               }
	       return return_message(message);
           }
        
           // man
           function man_c() {
               if(flags_b) return invalid_flags(command, flags);
               var length = 0;
               if(args_b) length = args.length;
               if(length != 1) return invalid_args_num(command, length, 1);
               for(var i = 0; i < CMDS.length; i++) {
                   var cmd = CMDS[i];
                   if(cmd.name == args[0]) return return_message(cmd.man);
               }
               return invalid_args(command, args);
           }
           
           // touch
           function touch_c() {
               if(flags_b) return invalid_flags(command, flags);
               var length = 0;
               if(args_b) length = args.length;
               if(length != 1) return invalid_args_num(command, length, 1);
               for(var i = 0; i < currentdir.items.length; i++) {
                   var item = currentdir.items[i];
                   if(args[0] == item.name) {
                       currentdir.items[i].ts = timestamp();
                       return return_message("");
                   }
               }
               // Create a blank file with the given name
               var name = args[0]; 
               currentdir.items.push(new Item(args[0], sizepad(0), true));
               return return_message("");
           }
 
           // EXECUTE COMMANDS
           if(command == "cat")    return cat_c();
           if(command == "evince") return evince_c();
           if(command == "exit")   return exit_c();
           if(command == "groups") return groups_c();
           if(command == "help")   return help_c();
           if(command == "ls")     return ls_c();
           if(command == "man")    return man_c();
           if(command == "touch")  return touch_c(); 
           // catches any unknown commands
           return [{msg:"tomsh: " + command + ": command not found",className:"jquery-console-message-value"}];
           },
           autofocus:true,
           animateScroll:true,
           promptHistory:true,
           welcomeMessage: 
`
   
  \\ \\   \\ \\     | |                             | |    
   \\ \\   \\ \\    | |_    ___    _ __ ___    ___  | |__  
    > >   > >   | __|  / _ \\  | '_ \` _ \\  / __| | '_ \\ 
   / /   / /    | |_  | (_) | | | | | | | \\__ \\ | | | |
  /_/   /_/      \\__|  \\___/  |_| |_| |_| |___/ |_| |_|

       Welcome to 'tom shell' (tomsh) - I'm Tom Goodman, and this is
   my personal website! tomsh works almost like a restricted subset
   of bash, so try what you can! If you manage to break it, (please
   try! :D) let me know and I'll do my best to deploy a fix ASAP <3
       
       If you need some help, type 'help', and you should be gucci. (If not,
   type 'evince CV.pdf' to open my CV!). Quick hint, 'Ctrl + l' will clear
   the screen (including this!).
       
       Enjoy! And let me know what you think!
                                              ~Tom - @TauOmicronMu
`,
           });
        });
    </script>
    
    <style>
      console1 {
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
      }
    </style>
    <style type="text/css" media="screen">
      body {
          top: 0;
          left: 0;
          margin: 0;
          padding: 0;
          overflow-x: hidden;
          overflow-y: hidden;
      }
      .jquery-console-inner .jquery-console-message { white-space: pre;}
      div.console1 { word-wrap: break-word; }
      div.console1 { font-size: 14px }
      div.console1 div.jquery-console-inner
       { width:100vw; height:100vh; background:#333; padding:0.5em;
         overflow:auto }
      div.console1 div.jquery-console-prompt-box
       { color:#fff; font-family:monospace; }
      div.console1 div.jquery-console-focus span.jquery-console-cursor
       { background:#fefefe; color:#333; font-weight:bold }
      div.console1 div.jquery-console-message-error
       { color:#ef0505; font-family:sans-serif; font-weight:bold;
         padding:0.1em; }
      div.console1 div.jquery-console-message-value
       { color:#1ad027; font-family:monospace;
         padding:0.1em; }
      div.console1 div.jquery-console-message-type
       { color:#52666f; font-family:monospace;
         padding:0.1em; }
      div.console1 span.jquery-console-prompt-label { font-weight:bold }
      div.jquery-console-welcome { text-align: center; color: #1ad027; font-family:monospace }
    </style>
  </head>
  <body>
  </body>
</html>
